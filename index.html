<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Naira Store</title>
<style>
  :root {
    --bg: #fff;
    --text: #222;
    --primary: #007bff;
    --secondary: #6c757d;
    --header-bg: var(--primary);
    --header-text: #fff;
    --border: #ddd;
  }
  [data-theme="dark"] {
    --bg: #121212;
    --text: #eee;
    --primary: #9b59b6;
    --secondary: #ccc;
    --header-bg: #2d2d2d;
    --header-text: #eee;
    --border: #444;
  }
  body {
    margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
      Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    transition: background 0.3s, color 0.3s;
    display: flex; flex-direction: column;
  }
  header {
    background: var(--header-bg);
    color: var(--header-text);
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
  }
  header h1 {
    margin: 0;
    font-size: 1.5rem;
    display: flex; align-items: center;
    gap: 0.5rem;
  }
  header img#storeLogo {
    height: 40px;
    max-width: 150px;
    object-fit: contain;
  }
  header .actions {
    display: flex;
    gap: 0.7rem;
    align-items: center;
  }
  button, input[type="button"] {
    background: var(--primary);
    border: none;
    color: white;
    padding: 0.4rem 0.9rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: background 0.25s;
  }
  button:hover, input[type="button"]:hover {
    background: #0056b3;
  }
  a {
    color: var(--primary);
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
  main {
    flex-grow: 1;
    max-width: 1100px;
    margin: 1rem auto 3rem;
    width: 90%;
  }
  .hidden {
    display: none !important;
  }
  .dark-toggle {
    background: transparent;
    border: 1.5px solid var(--header-text);
    color: var(--header-text);
    font-weight: 600;
    padding: 0.3rem 0.7rem;
    border-radius: 5px;
  }
  .dark-toggle:hover {
    background: var(--header-text);
    color: var(--header-bg);
  }
  input, select, textarea {
    font-size: 1rem;
    padding: 0.5rem;
    border: 1.5px solid var(--border);
    border-radius: 5px;
    width: 100%;
    background: var(--bg);
    color: var(--text);
    margin-top: 0.3rem;
    margin-bottom: 0.8rem;
    box-sizing: border-box;
  }
  label {
    font-weight: 600;
    display: block;
    margin-top: 1rem;
  }
  .form-group {
    margin-bottom: 0.8rem;
  }
  /* Layout for 2-column product grid */
  #shopProducts {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
    gap: 1rem;
  }
  .product-card {
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    background: var(--bg);
    transition: box-shadow 0.25s;
  }
  .product-card:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  .product-card img {
    max-width: 100%;
    height: 180px;
    object-fit: contain;
    border-radius: 5px;
    margin-bottom: 0.5rem;
  }
  .product-card h3 {
    margin: 0 0 0.3rem;
    font-size: 1.2rem;
  }
  .product-card .price {
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 0.5rem;
  }
  .product-card .availability {
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }
  .product-card .availability.instock {
    color: green;
  }
  .product-card .availability.outstock {
    color: red;
  }
  .product-card button {
    margin-top: auto;
  }
  /* Pagination */
  .pagination {
    margin: 1rem 0;
    text-align: center;
  }
  .pagination button {
    margin: 0 0.25rem;
    min-width: 35px;
  }
  /* Collections filter */
  #collectionsFilter {
    margin-bottom: 1rem;
  }
  #collectionsFilter select {
    max-width: 250px;
  }
  /* Cart styles */
  #cartSection {
    max-width: 450px;
    margin: 2rem auto;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    background: var(--bg);
  }
  #cartItems {
    margin-bottom: 1rem;
  }
  #cartItems .cart-item {
    border-bottom: 1px solid var(--border);
    padding: 0.4rem 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }
  #cartItems .cart-item:last-child {
    border-bottom: none;
  }
  #cartItems .cart-item-details {
    flex-grow: 1;
  }
  #cartItems .cart-item-qty {
    width: 50px;
  }
  #cartTotal {
    font-weight: 700;
    font-size: 1.2rem;
    text-align: right;
    margin-top: 0.8rem;
  }
  /* Forms inside admin */
  #adminPanel {
    max-width: 700px;
    margin: 1rem auto 4rem;
    background: var(--bg);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 1.2rem 1.5rem;
  }
  #adminPanel h2 {
    margin-top: 0;
  }
  #adminPanel .product-list {
    margin: 1rem 0 0;
    max-height: 300px;
    overflow-y: auto;
    border-top: 1.5px solid var(--border);
    padding-top: 1rem;
  }
  #adminPanel .product-list .admin-product {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.7rem;
    align-items: center;
  }
  #adminPanel .product-list .admin-product img {
    height: 50px;
    width: 50px;
    object-fit: contain;
    border-radius: 5px;
  }
  #adminPanel .product-list .admin-product-details {
    flex-grow: 1;
  }
  #adminPanel .product-list .admin-product-actions button {
    margin-left: 0.5rem;
    font-size: 0.9rem;
  }
  /* Admin login */
  #adminLogin {
    max-width: 350px;
    margin: 3rem auto 1rem;
    padding: 1.5rem 2rem;
    background: var(--bg);
    border: 1.5px solid var(--border);
    border-radius: 10px;
  }
  #adminLogin h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    text-align: center;
  }
  #adminLogin label {
    font-weight: 600;
  }
  #adminLogin input {
    margin-bottom: 1rem;
  }
  /* Customer login/sign-up */
  #customerLogin {
    max-width: 350px;
    margin: 2rem auto 2rem;
    padding: 1rem 1.2rem;
    background: var(--bg);
    border: 1.5px solid var(--border);
    border-radius: 10px;
  }
  #customerLogin h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    text-align: center;
  }
  #customerLogin label {
    font-weight: 600;
  }
  #customerLogin input {
    margin-bottom: 0.8rem;
  }
  #customerLogin button {
    width: 100%;
  }
  /* Checkout */
  #checkoutSection {
    max-width: 400px;
    margin: 2rem auto 3rem;
    padding: 1rem 1.2rem;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    background: var(--bg);
  }
  #checkoutSection h3 {
    margin-top: 0;
    margin-bottom: 1rem;
  }
  /* Confirmation popup */
  #confirmationPopup {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  #confirmationPopup .popup-content {
    background: var(--bg);
    padding: 1.8rem 2rem;
    border-radius: 12px;
    max-width: 320px;
    text-align: center;
    box-shadow: 0 6px 18px rgba(0,0,0,0.3);
  }
  #confirmationPopup button {
    margin-top: 1rem;
  }
  /* WhatsApp floating icon */
  #whatsappIcon {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #25d366;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 9999;
  }
  #whatsappIcon svg {
    fill: white;
    width: 28px;
    height: 28px;
  }
  /* Responsive tweaks */
  @media (max-width: 600px) {
    #shopProducts {
      grid-template-columns: 1fr !important;
    }
    header {
      flex-direction: column;
      gap: 0.7rem;
      align-items: flex-start;
    }
  }
</style>
</head>
<body>
<header>
  <h1><img id="storeLogo" src="" alt="Store Logo" class="hidden" /> <span id="storeNameTitle">My Naira Store</span></h1>
  <div class="actions">
    <button id="darkModeToggle" class="dark-toggle">ðŸŒ™ Dark Mode</button>
    <button id="cartBtn">Cart (<span id="cartCount">0</span>)</button>
    <button id="logoutBtn" class="hidden">Logout Admin</button>
  </div>
</header>
<main>
  <!-- Admin Login / Setup -->
  <section id="adminLogin" class="hidden" aria-label="Admin Login Section">
    <h2 id="adminLoginTitle">Admin Setup</h2>
    <form id="adminLoginForm">
      <label for="adminEmail">Admin Email</label>
      <input type="email" id="adminEmail" required autocomplete="username" />
      <label for="adminPassword">Password</label>
      <input type="password" id="adminPassword" required autocomplete="current-password" />
      <button type="submit" id="adminLoginSubmit">Create Admin Account</button>
    </form>
  </section>

  <!-- Admin Dashboard -->
  <section id="adminPanel" class="hidden" aria-label="Admin Dashboard">
    <h2>Admin Dashboard</h2>
    <button id="adminLogoutBtn">Logout</button>
    <h3>Store Settings</h3>
    <form id="storeSettingsForm">
      <label for="storeNameInput">Store Name</label>
      <input type="text" id="storeNameInput" />
      <label for="storeLogoInput">Store Logo (PNG/JPG)</label>
      <input type="file" id="storeLogoInput" accept="image/png, image/jpeg" />
      <label for="bankDetailsInput">Bank Details</label>
      <textarea id="bankDetailsInput" rows="2" placeholder="Bank name, account number, etc."></textarea>
      <label for="whatsappLinkInput">WhatsApp Link (https://wa.me/number)</label>
      <input type="url" id="whatsappLinkInput" placeholder="https://wa.me/234XXXXXXXXXX" />
      <button type="submit">Save Store Settings</button>
    </form>
    <hr />
    <h3>Manage Admin Account</h3>
    <form id="adminAccountForm">
      <label for="adminEmailChange">Change Admin Email</label>
      <input type="email" id="adminEmailChange" />
      <label for="adminPasswordChange">Change Admin Password</label>
      <input type="password" id="adminPasswordChange" />
      <button type="submit">Update Admin Account</button>
    </form>
    <hr />
    <h3>Products</h3>
    <form id="productForm">
      <label for="productNameInput">Product Name</label>
      <input type="text" id="productNameInput" required />
      <label for="productPriceInput">Price (â‚¦)</label>
      <input type="number" id="productPriceInput" required min="0" step="100" />
      <label for="productDescriptionInput">Description</label>
      <textarea id="productDescriptionInput" rows="3"></textarea>
      <label for="productAvailabilityInput">Availability</label>
      <select id="productAvailabilityInput">
        <option value="true" selected>In Stock</option>
        <option value="false">Out of Stock</option>
      </select>
      <label for="productColorsInput">Colors (comma separated)</label>
      <input type="text" id="productColorsInput" placeholder="e.g. Red, Blue, Green" />
      <label for="productSizesInput">Sizes (comma separated)</label>
      <input type="text" id="productSizesInput" placeholder="e.g. S, M, L, XL" />
      <label for="productImageInput">Product Image (PNG/JPG)</label>
      <input type="file" id="productImageInput" accept="image/png, image/jpeg" />
      <button type="submit" id="addProductBtn">Add Product</button>
    </form>
    <div class="product-list" id="adminProductList"></div>
    <hr />
    <h3>Orders</h3>
    <div id="ordersList"></div>
  </section>

  <!-- Shopping Area -->
  <section id="shopArea" class="hidden" aria-label="Shopping Area">
    <h2>Browse Collections</h2>
    <div id="collectionsFilter">
      <select id="collectionSelect">
        <option value="all">All Collections</option>
      </select>
    </div>
    <div id="shopProducts"></div>
    <div class="pagination" id="paginationControls"></div>
    <button id="customerLoginBtn">Login / Sign Up</button>
  </section>

  <!-- Customer Login / Signup -->
  <section id="customerLogin" class="hidden" aria-label="Customer Login Section">
    <h3>Customer Account</h3>
    <form id="customerLoginForm">
      <label for="customerNameInput">Name</label>
      <input type="text" id="customerNameInput" required />
      <label for="customerEmailInput">Email</label>
      <input type="email" id="customerEmailInput" required />
      <label for="customerPhoneInput">Phone Number</label>
      <input type="tel" id="customerPhoneInput" required />
      <button type="submit" id="customerLoginSubmit">Continue to Cart</button>
    </form>
  </section>

  <!-- Cart -->
  <section id="cartSection" class="hidden" aria-label="Shopping Cart">
    <h2>Your Cart</h2>
    <div id="cartItems"></div>
    <div id="cartTotal">Total: â‚¦0</div>
    <button id="checkoutBtn">Proceed to Checkout</button>
    <button id="backToShopBtn">Back to Shop</button>
  </section>

  <!-- Checkout -->
  <section id="checkoutSection" class="hidden" aria-label="Checkout Section">
    <h3>Checkout</h3>
    <div id="checkoutBankDetails"></div>
    <button id="confirmPaymentBtn">Iâ€™ve Paid</button>
    <button id="cancelCheckoutBtn">Cancel</button>
  </section>

  <!-- Confirmation Popup -->
  <div id="confirmationPopup" role="dialog" aria-modal="true" aria-labelledby="confirmationTitle" aria-describedby="confirmationDesc">
    <div class="popup-content">
      <h3 id="confirmationTitle">Order Confirmed!</h3>
      <p id="confirmationDesc">Thank you for your order. We will notify you once payment is confirmed.</p>
      <button id="closeConfirmationBtn">Close</button>
    </div>
  </div>

  <!-- WhatsApp Icon -->
  <div id="whatsappIcon" title="Contact us on WhatsApp" class="hidden" role="button" tabindex="0" aria-label="WhatsApp contact link">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.5 3.5a11.6 11.6 0 0 0-16.4 16.4l-2 5.5 5.5-2a11.6 11.6 0 0 0 13-19.9zm-7.1 14.8c-1.6 0-3.1-.9-4-2.3l-.3-.4-2.5 1 1-2.4-.3-.4a6.78 6.78 0 0 1 10-8.6 6.9 6.9 0 0 1-3.9 12.7zm3.2-5.3-.2-.4c-.1-.2-.2-.2-.3-.3-.1 0-.2 0-.4 0s-.3 0-.4.1l-.4.1-.3.1a3.24 3.24 0 0 1-1.2-1.2l-.2-.4-.4-.3c-.1 0-.2-.1-.2-.1l-.1 0c-.1 0-.1 0-.1.1a5.78 5.78 0 0 0-.7 2.5c0 1.4 1 2.7 2.4 3.2 1.2.5 2.6.4 3.7-.3a2.92 2.92 0 0 0 1.3-2.7c0-.2 0-.4 0-.5z"/></svg>
  </div>
</main>

<script src="https://cdn.emailjs.com/sdk/2.3.2/email.min.js"></script>
<script>
(() => {
  const PUBLIC_KEY = "RN5H1CcY7Fqkakg5w"; // Your EmailJS Public Key
  emailjs.init(PUBLIC_KEY);

  // URL path routing
  const path = window.location.pathname.toLowerCase();

  // Helpers
  function qs(sel) { return document.querySelector(sel); }
  function qsa(sel) { return document.querySelectorAll(sel); }
  function show(el) { el.classList.remove("hidden"); }
  function hide(el) { el.classList.add("hidden"); }
  function saveToLS(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
  function getFromLS(key, def=null) {
    try {
      const val = localStorage.getItem(key);
      if(val) return JSON.parse(val);
      return def;
    } catch { return def; }
  }

  // Admin auth keys in localStorage: adminEmail, adminPassHash (simple hash function used)
  // Store keys: products, orders, settings, customers, cart

  // Simple hash function for demo purposes (DO NOT USE IN PRODUCTION)
  function simpleHash(str) {
    let hash=0;
    for(let i=0;i<str.length;i++){
      hash=((hash<<5)-hash)+str.charCodeAt(i);
      hash |= 0;
    }
    return hash.toString();
  }

  // Initial UI elements
  const header = qs('header');
  const storeLogoImg = qs('#storeLogo');
  const storeNameTitle = qs('#storeNameTitle');
  const darkToggleBtn = qs('#darkModeToggle');
  const cartBtn = qs('#cartBtn');
  const cartCountSpan = qs('#cartCount');
  const logoutBtn = qs('#logoutBtn');

  // Admin UI
  const adminLoginSection = qs('#adminLogin');
  const adminLoginForm = qs('#adminLoginForm');
  const adminLoginTitle = qs('#adminLoginTitle');
  const adminEmailInput = qs('#adminEmail');
  const adminPasswordInput = qs('#adminPassword');
  const adminPanelSection = qs('#adminPanel');
  const adminLogoutBtn = qs('#adminLogoutBtn');
  const storeSettingsForm = qs('#storeSettingsForm');
  const storeNameInput = qs('#storeNameInput');
  const storeLogoInput = qs('#storeLogoInput');
  const bankDetailsInput = qs('#bankDetailsInput');
  const whatsappLinkInput = qs('#whatsappLinkInput');
  const adminAccountForm = qs('#adminAccountForm');
  const adminEmailChange = qs('#adminEmailChange');
  const adminPasswordChange = qs('#adminPasswordChange');
  const productForm = qs('#productForm');
  const productNameInput = qs('#productNameInput');
  const productPriceInput = qs('#productPriceInput');
  const productDescriptionInput = qs('#productDescriptionInput');
  const productAvailabilityInput = qs('#productAvailabilityInput');
  const productColorsInput = qs('#productColorsInput');
  const productSizesInput = qs('#productSizesInput');
  const productImageInput = qs('#productImageInput');
  const adminProductList = qs('#adminProductList');
  const ordersList = qs('#ordersList');

  // Shop UI
  const shopAreaSection = qs('#shopArea');
  const collectionsFilter = qs('#collectionSelect');
  const shopProductsContainer = qs('#shopProducts');
  const paginationControls = qs('#paginationControls');
  const customerLoginBtn = qs('#customerLoginBtn');

  // Customer login UI
  const customerLoginSection = qs('#customerLogin');
  const customerLoginForm = qs('#customerLoginForm');
  const customerNameInput = qs('#customerNameInput');
  const customerEmailInput = qs('#customerEmailInput');
  const customerPhoneInput = qs('#customerPhoneInput');

  // Cart UI
  const cartSection = qs('#cartSection');
  const cartItemsContainer = qs('#cartItems');
  const cartTotalDiv = qs('#cartTotal');
  const checkoutBtn = qs('#checkoutBtn');
  const backToShopBtn = qs('#backToShopBtn');

  // Checkout UI
  const checkoutSection = qs('#checkoutSection');
  const checkoutBankDetailsDiv = qs('#checkoutBankDetails');
  const confirmPaymentBtn = qs('#confirmPaymentBtn');
  const cancelCheckoutBtn = qs('#cancelCheckoutBtn');

  // Confirmation Popup UI
  const confirmationPopup = qs('#confirmationPopup');
  const closeConfirmationBtn = qs('#closeConfirmationBtn');

  // WhatsApp Icon
  const whatsappIcon = qs('#whatsappIcon');

  // State variables
  let adminLoggedIn = false;
  let currentAdminEmail = null;
  let products = getFromLS('products', []);
  let orders = getFromLS('orders', []);
  let settings = getFromLS('settings', {
    storeName: 'My Naira Store',
    storeLogo: '',
    bankDetails: 'Demo Bank â€” 0000000000',
    whatsappLink: '',
    emailjsServiceId: '',
    emailjsTemplateId: '',
  });
  let customers = getFromLS('customers', []);
  let cart = getFromLS('cart', []);
  let currentCustomer = null;

  // Pagination
  const PRODUCTS_PER_PAGE = 6;
  let currentPage = 1;
  let currentCollection = 'all';

  // Initialize theme from localStorage
  function applyTheme(theme) {
    if(theme === 'dark'){
      document.documentElement.setAttribute('data-theme', 'dark');
      darkToggleBtn.textContent = 'â˜€ï¸ Light Mode';
    } else {
      document.documentElement.setAttribute('data-theme', 'light');
      darkToggleBtn.textContent = 'ðŸŒ™ Dark Mode';
    }
    localStorage.setItem('theme', theme);
  }
  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    applyTheme(current === 'dark' ? 'light' : 'dark');
  }
  const savedTheme = localStorage.getItem('theme') || 'light';
  applyTheme(savedTheme);
  darkToggleBtn.addEventListener('click', toggleTheme);

  // Helper: Validate admin credentials
  function verifyAdmin(email, pass) {
    const savedEmail = localStorage.getItem('adminEmail');
    const savedPassHash = localStorage.getItem('adminPassHash');
    if(!savedEmail || !savedPassHash) return false;
    return savedEmail === email && savedPassHash === simpleHash(pass);
  }

  // Admin login or setup
  function showAdminLogin(setup=false) {
    adminLoginTitle.textContent = setup ? 'Admin Setup' : 'Admin Login';
    adminLoginForm.querySelector('button').textContent = setup ? 'Create Admin Account' : 'Login';
    show(adminLoginSection);
    hide(adminPanelSection);
    hide(shopAreaSection);
    hide(customerLoginSection);
    hide(cartSection);
    hide(checkoutSection);
    logoutBtn.classList.add('hidden');
  }
  function showAdminPanel() {
    hide(adminLoginSection);
    show(adminPanelSection);
    hide(shopAreaSection);
    hide(customerLoginSection);
    hide(cartSection);
    hide(checkoutSection);
    logoutBtn.classList.remove('hidden');
  }
  // Customer shopping area UI
  function showShopArea() {
    hide(adminLoginSection);
    hide(adminPanelSection);
    show(shopAreaSection);
    hide(customerLoginSection);
    hide(cartSection);
    hide(checkoutSection);
    logoutBtn.classList.add('hidden');
    renderStoreHeader();
    renderCollectionsFilter();
    renderProducts();
    renderCartCount();
    updateWhatsAppIcon();
  }
  // Customer login UI
  function showCustomerLogin() {
    hide(adminLoginSection);
    hide(adminPanelSection);
    hide(shopAreaSection);
    show(customerLoginSection);
    hide(cartSection);
    hide(checkoutSection);
  }
  // Cart UI
  function showCart() {
    hide(adminLoginSection);
    hide(adminPanelSection);
    hide(shopAreaSection);
    hide(customerLoginSection);
    show(cartSection);
    hide(checkoutSection);
    renderCart();
  }
  // Checkout UI
  function showCheckout() {
    hide(adminLoginSection);
    hide(adminPanelSection);
    hide(shopAreaSection);
    hide(customerLoginSection);
    hide(cartSection);
    show(checkoutSection);
    renderCheckout();
  }

  // Render functions
  function renderStoreHeader(){
    storeNameTitle.textContent = settings.storeName || 'My Naira Store';
    if(settings.storeLogo){
      storeLogoImg.src = settings.storeLogo;
      storeLogoImg.classList.remove('hidden');
    } else {
      storeLogoImg.classList.add('hidden');
    }
  }

  function renderCollectionsFilter(){
    const collections = new Set();
    products.forEach(p => {
      if(p.colors) p.colors.split(',').forEach(c => collections.add(c.trim()));
      if(p.sizes) p.sizes.split(',').forEach(s => collections.add(s.trim()));
    });
    const prevVal = collectionsFilter.value;
    collectionsFilter.innerHTML = '<option value="all">All Collections</option>';
    collections.forEach(c => {
      collectionsFilter.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`);
    });
    collectionsFilter.value = prevVal && collectionsFilter.querySelector(`option[value="${prevVal}"]`) ? prevVal : 'all';
  }

  // Filter products by collection (color or size)
  function filterProductsByCollection() {
    if(currentCollection === 'all') return products;
    return products.filter(p => {
      const colors = p.colors ? p.colors.toLowerCase().split(',').map(x=>x.trim()) : [];
      const sizes = p.sizes ? p.sizes.toLowerCase().split(',').map(x=>x.trim()) : [];
      return colors.includes(currentCollection.toLowerCase()) || sizes.includes(currentCollection.toLowerCase());
    });
  }

  function renderProducts(){
    const filtered = filterProductsByCollection();
    const totalPages = Math.ceil(filtered.length / PRODUCTS_PER_PAGE);
    if(currentPage > totalPages) currentPage = 1;

    const start = (currentPage -1)*PRODUCTS_PER_PAGE;
    const paginated = filtered.slice(start, start+PRODUCTS_PER_PAGE);

    shopProductsContainer.innerHTML = '';
    if(paginated.length === 0){
      shopProductsContainer.innerHTML = '<p>No products found in this collection.</p>';
      paginationControls.innerHTML = '';
      return;
    }
    paginated.forEach(p => {
      const availClass = p.availability === "true" ? 'instock' : 'outstock';
      const availText = p.availability === "true" ? 'In Stock' : 'Out of Stock';
      const colorsDisplay = p.colors ? p.colors.split(',').map(c => c.trim()).join(', ') : 'N/A';
      const sizesDisplay = p.sizes ? p.sizes.split(',').map(s => s.trim()).join(', ') : 'N/A';

      const productCard = document.createElement('div');
      productCard.className = 'product-card';
      productCard.innerHTML = `
        <img src="${p.image}" alt="${p.name}" />
        <h3>${p.name}</h3>
        <div class="price">â‚¦${Number(p.price).toLocaleString()}</div>
        <div class="availability ${availClass}">${availText}</div>
        <div><strong>Colors:</strong> ${colorsDisplay}</div>
        <div><strong>Sizes:</strong> ${sizesDisplay}</div>
        <button ${p.availability !== "true" ? 'disabled' : ''} data-id="${p.id}">Add to Cart</button>
      `;
      shopProductsContainer.appendChild(productCard);
    });
    renderPagination(totalPages);
  }

  function renderPagination(totalPages){
    paginationControls.innerHTML = '';
    if(totalPages <= 1) return;
    for(let i=1;i<=totalPages;i++){
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.disabled = (i === currentPage);
      btn.addEventListener('click', () => {
        currentPage = i;
        renderProducts();
      });
      paginationControls.appendChild(btn);
    }
  }

  function renderCartCount(){
    cartCountSpan.textContent = cart.reduce((sum, item) => sum + item.qty, 0);
  }

  // Add product to cart prompt options (color, size, qty)
  function addToCartPrompt(productId){
    const product = products.find(p => p.id === productId);
    if(!product) return alert('Product not found');

    let selectedColor = null;
    let selectedSize = null;
    let quantity = 1;

    // Create modal prompt for options
    const modal = document.createElement('div');
    modal.style.position = 'fixed';
    modal.style.top = '0'; modal.style.left = '0';
    modal.style.width = '100vw'; modal.style.height = '100vh';
    modal.style.background = 'rgba(0,0,0,0.4)';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.style.zIndex = '10000';

    modal.innerHTML = `
      <div style="background: var(--bg); padding: 1.5rem; border-radius: 10px; width: 320px; max-width: 90vw; box-sizing: border-box;">
        <h3>Add "${product.name}" to Cart</h3>
        <form id="addCartForm">
          <label>Color</label>
          <select id="colorSelect" ${!product.colors ? 'disabled' : ''}>
            ${product.colors ? `<option value="">Select color</option>` + product.colors.split(',').map(c => `<option value="${c.trim()}">${c.trim()}</option>`).join('') : '<option>N/A</option>'}
          </select>
          <label>Size</label>
          <select id="sizeSelect" ${!product.sizes ? 'disabled' : ''}>
            ${product.sizes ? `<option value="">Select size</option>` + product.sizes.split(',').map(s => `<option value="${s.trim()}">${s.trim()}</option>`).join('') : '<option>N/A</option>'}
          </select>
          <label>Quantity</label>
          <input type="number" id="qtyInput" min="1" value="1" />
          <div style="margin-top:1rem; text-align: right;">
            <button type="submit" style="margin-right: 0.5rem;">Add</button>
            <button type="button" id="cancelAddCart">Cancel</button>
          </div>
        </form>
      </div>
    `;

    document.body.appendChild(modal);

    const addCartForm = modal.querySelector('#addCartForm');
    const cancelBtn = modal.querySelector('#cancelAddCart');

    addCartForm.addEventListener('submit', e => {
      e.preventDefault();
      selectedColor = modal.querySelector('#colorSelect').value;
      selectedSize = modal.querySelector('#sizeSelect').value;
      quantity = parseInt(modal.querySelector('#qtyInput').value);

      if(product.colors && !selectedColor) return alert('Please select a color');
      if(product.sizes && !selectedSize) return alert('Please select a size');
      if(quantity <= 0) return alert('Quantity must be at least 1');

      // Add or update cart
      let existingItemIndex = cart.findIndex(i =>
        i.productId === productId &&
        i.color === selectedColor &&
        i.size === selectedSize
      );
      if(existingItemIndex > -1){
        cart[existingItemIndex].qty += quantity;
      } else {
        cart.push({
          productId,
          name: product.name,
          price: product.price,
          color: selectedColor,
          size: selectedSize,
          qty: quantity,
          image: product.image
        });
      }
      saveToLS('cart', cart);
      renderCartCount();
      alert('Added to cart!');
      document.body.removeChild(modal);
    });

    cancelBtn.addEventListener('click', () => {
      document.body.removeChild(modal);
    });
  }

  // Render cart items
  function renderCart(){
    if(cart.length === 0){
      cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
      cartTotalDiv.textContent = 'Total: â‚¦0';
      return;
    }
    cartItemsContainer.innerHTML = '';
    cart.forEach((item, index) => {
      const itemTotal = item.qty * Number(item.price);
      const cartItemDiv = document.createElement('div');
      cartItemDiv.className = 'cart-item';
      cartItemDiv.innerHTML = `
        <img src="${item.image}" alt="${item.name}" style="height:50px; width:50px; object-fit:contain; border-radius:5px;" />
        <div class="cart-item-details">
          <strong>${item.name}</strong><br/>
          <small>Color: ${item.color || 'N/A'}, Size: ${item.size || 'N/A'}</small><br/>
          <small>â‚¦${Number(item.price).toLocaleString()} Ã— </small>
          <input type="number" min="1" value="${item.qty}" class="cart-item-qty" data-index="${index}" />
          <small> = â‚¦${itemTotal.toLocaleString()}</small>
        </div>
        <button data-index="${index}" aria-label="Remove item from cart">Remove</button>
      `;
      cartItemsContainer.appendChild(cartItemDiv);
    });
    const totalAmount = cart.reduce((sum, i) => sum + i.qty * Number(i.price), 0);
    cartTotalDiv.textContent = `Total: â‚¦${totalAmount.toLocaleString()}`;
  }

  // Cart event listeners for qty change and remove
  cartItemsContainer.addEventListener('input', e => {
    if(e.target.classList.contains('cart-item-qty')){
      const idx = Number(e.target.dataset.index);
      let val = parseInt(e.target.value);
      if(isNaN(val) || val < 1) val = 1;
      cart[idx].qty = val;
      saveToLS('cart', cart);
      renderCartCount();
      renderCart();
    }
  });
  cartItemsContainer.addEventListener('click', e => {
    if(e.target.tagName === 'BUTTON' && e.target.dataset.index){
      const idx = Number(e.target.dataset.index);
      cart.splice(idx,1);
      saveToLS('cart', cart);
      renderCartCount();
      renderCart();
    }
  });

  // Render checkout section
  function renderCheckout(){
    checkoutBankDetailsDiv.textContent = settings.bankDetails || 'Bank details not set.';
  }

  // Handle confirm payment
  function confirmPayment(){
    if(!currentCustomer){
      alert('No customer info found. Please login again.');
      showCustomerLogin();
      return;
    }
    if(cart.length === 0){
      alert('Cart is empty.');
      showShopArea();
      return;
    }
    // Create order
    const orderId = 'ORD' + Date.now();
    const newOrder = {
      id: orderId,
      customer: currentCustomer,
      items: cart,
      total: cart.reduce((sum, i) => sum + i.qty * Number(i.price), 0),
      status: 'PENDING',
      createdAt: new Date().toISOString(),
    };
    orders.push(newOrder);
    saveToLS('orders', orders);
    cart = [];
    saveToLS('cart', cart);
    renderCartCount();
    showConfirmationPopup();

    // Send emails via EmailJS if configured
    if(settings.emailjsServiceId && settings.emailjsTemplateId){
      // Send email to store owner
      emailjs.send(settings.emailjsServiceId, settings.emailjsTemplateId, {
        order_id: newOrder.id,
        customer_name: newOrder.customer.name,
        customer_email: newOrder.customer.email,
        customer_phone: newOrder.customer.phone,
        items: JSON.stringify(newOrder.items),
        total: `â‚¦${newOrder.total.toLocaleString()}`,
        status: newOrder.status
      }).then(() => {
        console.log('Order email sent to store owner.');
      }).catch(e => console.error('EmailJS error:', e));
      // Optionally, send confirmation email to customer here with another template
    }
  }

  function showConfirmationPopup(){
    confirmationPopup.style.display = 'flex';
  }
  function hideConfirmationPopup(){
    confirmationPopup.style.display = 'none';
  }

  // Admin Products Render
  function renderAdminProducts(){
    if(products.length === 0){
      adminProductList.innerHTML = '<p>No products added yet.</p>';
      return;
    }
    adminProductList.innerHTML = '';
    products.forEach((p, i) => {
      const availClass = p.availability === "true" ? 'instock' : 'outstock';
      const availText = p.availability === "true" ? 'In Stock' : 'Out of Stock';

      const div = document.createElement('div');
      div.className = 'admin-product';
      div.innerHTML = `
        <img src="${p.image}" alt="${p.name}" />
        <div class="admin-product-details">
          <strong>${p.name}</strong><br/>
          â‚¦${Number(p.price).toLocaleString()} - <span class="${availClass}">${availText}</span><br/>
          Colors: ${p.colors || 'N/A'}<br/>
          Sizes: ${p.sizes || 'N/A'}
        </div>
        <div class="admin-product-actions">
          <button data-index="${i}" class="editProductBtn">Edit</button>
          <button data-index="${i}" class="deleteProductBtn">Delete</button>
        </div>
      `;
      adminProductList.appendChild(div);
    });
  }

  // Admin Orders Render
  function renderOrders(){
    if(orders.length === 0){
      ordersList.innerHTML = '<p>No orders yet.</p>';
      return;
    }
    ordersList.innerHTML = '';
    orders.forEach((order, idx) => {
      const itemsDesc = order.items.map(i => `${i.name} (Color: ${i.color}, Size: ${i.size}, Qty: ${i.qty})`).join('<br/>');
      const orderDiv = document.createElement('div');
      orderDiv.style.borderBottom = '1.5px solid var(--border)';
      orderDiv.style.padding = '0.7rem 0';
      orderDiv.innerHTML = `
        <strong>Order ID:</strong> ${order.id}<br/>
        <strong>Customer:</strong> ${order.customer.name} (${order.customer.email}, ${order.customer.phone})<br/>
        <strong>Items:</strong><br/>${itemsDesc}<br/>
        <strong>Total:</strong> â‚¦${Number(order.total).toLocaleString()}<br/>
        <strong>Status:</strong> ${order.status}<br/>
        <button data-index="${idx}" class="markPaidBtn" ${order.status==='PAID'?'disabled':''}>Mark Paid</button>
      `;
      ordersList.appendChild(orderDiv);
    });
  }

  // Utility to convert uploaded file to base64
  function fileToBase64(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = e => reject(e);
      reader.readAsDataURL(file);
    });
  }

  // Initialization
  function init(){
    // Check if admin account exists
    const adminEmailStored = localStorage.getItem('adminEmail');
    const adminPassHashStored = localStorage.getItem('adminPassHash');

    if(!adminEmailStored || !adminPassHashStored){
      // Setup mode
      showAdminLogin(true);
    } else {
      // Check path for /admin or /shop
      if(path === '/admin'){
        // Need login first
        showAdminLogin(false);
      } else if(path === '/shop' || path === '/'){
        showShopArea();
      } else {
        // fallback to shop
        showShopArea();
      }
    }
    renderStoreHeader();
  }
  init();

  // Admin login form
  adminLoginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = adminEmailInput.value.trim().toLowerCase();
    const pass = adminPasswordInput.value.trim();
    if(!email || !pass){
      alert('Please enter email and password.');
      return;
    }
    if(localStorage.getItem('adminEmail')){
      // login mode
      if(verifyAdmin(email, pass)){
        adminLoggedIn = true;
        currentAdminEmail = email;
        adminEmailInput.value = '';
        adminPasswordInput.value = '';
        showAdminPanel();
        loadAdminData();
      } else {
        alert('Invalid admin credentials.');
      }
    } else {
      // setup mode
      localStorage.setItem('adminEmail', email);
      localStorage.setItem('adminPassHash', simpleHash(pass));
      alert('Admin account created. Please log in.');
      showAdminLogin(false);
    }
  });

  // Admin logout buttons
  adminLogoutBtn.addEventListener('click', () => {
    adminLoggedIn = false;
    currentAdminEmail = null;
    showAdminLogin(false);
  });
  logoutBtn.addEventListener('click', () => {
    adminLoggedIn = false;
    currentAdminEmail = null;
    showAdminLogin(false);
  });

  // Load admin data into forms
  function loadAdminData(){
    storeNameInput.value = settings.storeName || '';
    bankDetailsInput.value = settings.bankDetails || '';
    whatsappLinkInput.value = settings.whatsappLink || '';
    adminEmailChange.value = localStorage.getItem('adminEmail') || '';
    adminPasswordChange.value = '';
    renderAdminProducts();
    renderOrders();
    renderStoreHeader();
    updateWhatsAppIcon();
  }

  // Store Settings form submit
  storeSettingsForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    settings.storeName = storeNameInput.value.trim() || 'My Naira Store';
    settings.bankDetails = bankDetailsInput.value.trim() || 'Demo Bank â€” 0000000000';
    settings.whatsappLink = whatsappLinkInput.value.trim() || '';
    // Logo file base64
    if(storeLogoInput.files.length > 0){
      const file = storeLogoInput.files[0];
      try {
        const base64 = await fileToBase64(file);
        settings.storeLogo = base64;
      } catch(e) {
        alert('Error loading logo image.');
        return;
      }
    }
    saveToLS('settings', settings);
    alert('Store settings saved.');
    renderStoreHeader();
    updateWhatsAppIcon();
  });

  // Admin Account change form
  adminAccountForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const newEmail = adminEmailChange.value.trim().toLowerCase();
    const newPass = adminPasswordChange.value.trim();
    if(newEmail){
      localStorage.setItem('adminEmail', newEmail);
    }
    if(newPass){
      localStorage.setItem('adminPassHash', simpleHash(newPass));
    }
    alert('Admin account updated.');
    adminEmailChange.value = '';
    adminPasswordChange.value = '';
  });

  // Product image upload preview & base64 conversion on add/edit
  let currentEditProductIndex = null;

  productForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = productNameInput.value.trim();
    const price = Number(productPriceInput.value);
    const description = productDescriptionInput.value.trim();
    const availability = productAvailabilityInput.value;
    const colors = productColorsInput.value.trim();
    const sizes = productSizesInput.value.trim();
    let imageBase64 = null;

    if(!name || !price || !productAvailabilityInput.value) {
      alert('Please fill required fields.');
      return;
    }

    if(productImageInput.files.length > 0){
      try {
        imageBase64 = await fileToBase64(productImageInput.files[0]);
      } catch {
        alert('Failed to load product image.');
        return;
      }
    } else if(currentEditProductIndex !== null){
      imageBase64 = products[currentEditProductIndex].image;
    } else {
      alert('Please upload a product image.');
      return;
    }

    if(currentEditProductIndex !== null){
      // update existing
      products[currentEditProductIndex] = {
        ...products[currentEditProductIndex],
        name, price, description, availability, colors, sizes, image: imageBase64
      };
      alert('Product updated.');
      currentEditProductIndex = null;
      productForm.querySelector('#addProductBtn').textContent = 'Add Product';
    } else {
      // add new
      products.push({
        id: 'P' + Date.now(),
        name, price, description, availability, colors, sizes, image: imageBase64
      });
      alert('Product added.');
    }

    saveToLS('products', products);
    renderAdminProducts();
    productForm.reset();
  });

  // Edit / Delete product buttons
  adminProductList.addEventListener('click', async (e) => {
    if(e.target.classList.contains('editProductBtn')){
      const idx = Number(e.target.dataset.index);
      currentEditProductIndex = idx;
      const p = products[idx];
      productNameInput.value = p.name;
      productPriceInput.value = p.price;
      productDescriptionInput.value = p.description;
      productAvailabilityInput.value = p.availability;
      productColorsInput.value = p.colors;
      productSizesInput.value = p.sizes;
      productForm.querySelector('#addProductBtn').textContent = 'Update Product';
      window.scrollTo({top:0,behavior:'smooth'});
    } else if(e.target.classList.contains('deleteProductBtn')){
      const idx = Number(e.target.dataset.index);
      if(confirm('Delete this product?')){
        products.splice(idx,1);
        saveToLS('products', products);
        renderAdminProducts();
      }
    }
  });

  // Orders mark paid button
  ordersList.addEventListener('click', (e) => {
    if(e.target.classList.contains('markPaidBtn')){
      const idx = Number(e.target.dataset.index);
      const order = orders[idx];
      if(order.status !== 'PAID'){
        order.status = 'PAID';
        saveToLS('orders', orders);
        renderOrders();
        alert(`Order ${order.id} marked as PAID.`);
        // Optionally, send payment confirmation email to customer here
      }
    }
  });

  // Shop add to cart buttons
  shopProductsContainer.addEventListener('click', e => {
    if(e.target.tagName === 'BUTTON' && e.target.dataset.id){
      const id = e.target.dataset.id;
      addToCartPrompt(id);
    }
  });

  // Collections filter change
  collectionsFilter.addEventListener('change', () => {
    currentCollection = collectionsFilter.value;
    currentPage = 1;
    renderProducts();
  });

  // Cart button click
  cartBtn.addEventListener('click', () => {
    if(cart.length === 0){
      alert('Your cart is empty.');
      return;
    }
    showCart();
  });

  // Customer login button in shop
  customerLoginBtn.addEventListener('click', () => {
    showCustomerLogin();
  });

  // Customer login form
  customerLoginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = customerNameInput.value.trim();
    const email = customerEmailInput.value.trim().toLowerCase();
    const phone = customerPhoneInput.value.trim();
    if(!name || !email || !phone){
      alert('Please fill all fields.');
      return;
    }
    currentCustomer = {name, email, phone};
    customers.push(currentCustomer);
    saveToLS('customers', customers);
    alert('Welcome, ' + name + '! Proceed to your cart.');
    customerLoginForm.reset();
    showCart();
  });

  // Cart buttons
  checkoutBtn.addEventListener('click', () => {
    showCheckout();
  });
  backToShopBtn.addEventListener('click', () => {
    showShopArea();
  });

  cancelCheckoutBtn.addEventListener('click', () => {
    showCart();
  });

  confirmPaymentBtn.addEventListener('click', () => {
    confirmPayment();
  });

  closeConfirmationBtn.addEventListener('click', () => {
    hideConfirmationPopup();
    showShopArea();
  });

  // Update WhatsApp icon
  function updateWhatsAppIcon(){
    if(settings.whatsappLink){
      whatsappIcon.classList.remove('hidden');
      whatsappIcon.onclick = () => {
        window.open(settings.whatsappLink, '_blank');
      };
      whatsappIcon.onkeypress = (e) => {
        if(e.key === 'Enter' || e.key === ' ') whatsappIcon.click();
      };
    } else {
      whatsappIcon.classList.add('hidden');
    }
  }

  // Render cart count on load
  renderCartCount();

  // Routing logic - show admin panel if logged in and path is /admin
  if(path === '/admin'){
    if(localStorage.getItem('adminEmail')){
      showAdminLogin(false);
    } else {
      showAdminLogin(true);
    }
  } else if(path === '/shop' || path === '/'){
    showShopArea();
  } else {
    showShopArea();
  }
})();
</script>
</body>
</html>
