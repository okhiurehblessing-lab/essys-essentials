<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Store</title>
<style>
  /* Basic styling & dark mode toggle */
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0; background: #f5f5f5; color: #222;
  }
  body.dark {
    background: #121212; color: #eee;
  }
  header, footer {
    padding: 1rem; background: #333; color: white;
  }
  .store-name {
    font-size: 1.5rem;
    font-weight: bold;
  }
  #whatsapp-link {
    color: #25D366;
    margin-left: 1rem;
    text-decoration: none;
    font-weight: bold;
  }
  nav button {
    margin-left: 1rem;
    cursor: pointer;
  }
  /* Sections hidden by default */
  section { display: none; padding: 1rem; }
  section.active { display: block; }

  /* Product grid - 2 columns */
  #product-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }
  .product-card {
    border: 1px solid #ddd;
    border-radius: 5px;
    background: white;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  body.dark .product-card {
    background: #222;
    border-color: #444;
  }
  .product-image {
    width: 100%;
    height: 160px;
    object-fit: contain;
    margin-bottom: 0.5rem;
  }
  .product-name {
    font-weight: bold;
    margin-bottom: 0.3rem;
  }
  .product-price {
    color: #007700;
    margin-bottom: 0.5rem;
  }
  .product-stock {
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
  }
  .btn {
    background: #0077cc;
    border: none;
    color: white;
    padding: 0.5rem;
    cursor: pointer;
    border-radius: 3px;
  }
  .btn:disabled {
    background: #999;
    cursor: not-allowed;
  }
  /* Cart and checkout */
  #cart-items {
    margin-top: 1rem;
  }
  .cart-item {
    border-bottom: 1px solid #ccc;
    padding: 0.5rem 0;
    display: flex; justify-content: space-between; align-items: center;
  }
  .cart-item div {
    flex: 1;
  }
  .cart-qty-input {
    width: 50px;
    padding: 0.2rem;
  }
  /* Checkout */
  #checkout {
    margin-top: 1rem;
    border-top: 1px solid #ccc;
    padding-top: 1rem;
  }
  label {
    display: block;
    margin: 0.5rem 0 0.2rem;
  }
  input, select, textarea {
    width: 100%;
    padding: 0.4rem;
    box-sizing: border-box;
  }
  #delivery-area-msg, #stockpiling-msg {
    margin-top: 0.5rem;
  }
  /* Admin styles */
  #admin-panel input, #admin-panel textarea, #admin-panel select {
    margin-bottom: 0.5rem;
  }
  #admin-panel label {
    font-weight: bold;
  }
  #admin-products-list .admin-product {
    border-bottom: 1px solid #ccc;
    padding: 0.5rem 0;
    display: flex; justify-content: space-between; align-items: center;
  }
  #admin-products-list img {
    width: 50px; height: 50px; object-fit: contain; margin-right: 0.5rem;
  }
  .admin-btn {
    background: #cc7700;
    border: none;
    color: white;
    padding: 0.3rem 0.7rem;
    cursor: pointer;
    border-radius: 3px;
    margin-left: 0.3rem;
  }
  /* Pagination */
  #pagination {
    margin-top: 1rem;
    text-align: center;
  }
  #pagination button {
    margin: 0 0.3rem;
  }
</style>
</head>
<body>
<header>
  <span class="store-name">My Store</span>
  <a id="whatsapp-link" href="#" target="_blank" title="Contact us on WhatsApp">WhatsApp</a>
  <button id="dark-mode-toggle">Dark Mode</button>
  <button id="logout-btn" style="display:none;">Logout</button>
</header>

<!-- LOGIN -->
<section id="login-screen" class="active">
  <h2>Admin Login</h2>
  <form id="login-form">
    <label>Email:</label>
    <input type="email" id="login-email" required />
    <label>Password:</label>
    <input type="password" id="login-password" required />
    <button type="submit" class="btn">Login</button>
  </form>
</section>

<!-- ADMIN PANEL -->
<section id="admin-panel">
  <h2>Admin Dashboard</h2>
  <button id="back-to-shop-btn">Back to Storefront</button>

  <h3>Store Customization</h3>
  <form id="customization-form">
    <label>Store Name:</label>
    <input type="text" id="store-name-input" />
    <label>WhatsApp Number (include country code, e.g. 2348012345678):</label>
    <input type="text" id="whatsapp-input" />
    <label>Allow Stockpiling (customers can order more than stock):</label>
    <select id="stockpiling-select">
      <option value="true">Yes</option>
      <option value="false">No</option>
    </select>
    <label>Delivery Fees (JSON format):</label>
    <textarea id="delivery-fees-input" rows="6" style="font-family: monospace;"></textarea>
    <button type="submit" class="btn">Save Customization</button>
  </form>

  <h3>Manage Products</h3>
  <form id="product-form">
    <input type="hidden" id="product-id" />
    <label>Name:</label>
    <input type="text" id="product-name" required />
    <label>Price (₦):</label>
    <input type="number" id="product-price" required min="0" />
    <label>Description:</label>
    <textarea id="product-desc"></textarea>
    <label>Stock Quantity:</label>
    <input type="number" id="product-stock" min="0" />
    <label>Colors (comma separated):</label>
    <input type="text" id="product-colors" placeholder="Red, Blue, Green" />
    <label>Sizes (comma separated):</label>
    <input type="text" id="product-sizes" placeholder="S, M, L, XL" />
    <label>Image (paste base64 data URI):</label>
    <textarea id="product-image" rows="3" placeholder="data:image/png;base64,..."></textarea>
    <button type="submit" class="btn">Add / Update Product</button>
  </form>

  <div id="admin-products-list"></div>
</section>

<!-- SHOPPING AREA -->
<section id="shopping-area">
  <h2 class="store-name"></h2>
  <div id="product-list"></div>

  <div id="pagination"></div>

  <h3>Cart</h3>
  <div id="cart-items"></div>
  <button id="proceed-to-checkout" class="btn">Proceed to Checkout</button>

  <section id="checkout" class="hidden">
    <h3>Checkout</h3>
    <form id="checkout-form">
      <label for="checkout-name">Name:</label>
      <input id="checkout-name" type="text" required />
      <label for="checkout-email">Email:</label>
      <input id="checkout-email" type="email" required />
      <label for="checkout-phone">Phone:</label>
      <input id="checkout-phone" type="tel" required />
      <label for="checkout-address">Delivery Address:</label>
      <textarea id="checkout-address" required></textarea>
      <label for="delivery-area">Select Delivery Area:</label>
      <select id="delivery-area" required></select>
      <div id="delivery-area-msg" style="color: #b36b00; margin-top: 5px; display: none;"></div>
      <div id="stockpiling-msg" style="color: red; margin-top: 10px; display: none;"></div>
      <div style="margin-top: 1rem;">
        <div>Subtotal: <span id="checkout-subtotal">₦0</span></div>
        <div>Delivery Fee: <span id="checkout-shipping-fee">₦0</span></div>
        <div><strong>Total: <span id="checkout-total">₦0</span></strong></div>
      </div>
      <button type="submit" class="btn" style="margin-top:1rem;">Place Order</button>
    </form>
  </section>
</section>

<script src="https://cdn.emailjs.com/sdk/3.2.0/email.min.js"></script>
<script>
  emailjs.init('RN5H1CcY7Fqkakg5w'); // Your public key here
</script>

<script>
  // -- STATE AND STORAGE KEYS --
  const STORAGE_KEYS = {
    PRODUCTS: 'my_store_products',
    CART: 'my_store_cart',
    ADMIN: 'my_store_admin',
    CUSTOMIZATION: 'my_store_customization',
    ORDERS: 'my_store_orders',
  };

  const state = {
    products: [],
    cart: [],
    currentUser: null,
    adminCredentials: null,
    customization: {
      storeName: 'My Store',
      whatsapp: '2348012345678',
      allowStockpiling: false,
      deliveryFees: {
        'Ikeja': 500,
        'Lekki': 700,
        'Yaba': 400,
        'Others': 0,
        'Outside Lagos': 1500
      }
    },
    orders: [],
  };

  // --- HELPERS ---
  function saveData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
  function loadData(key) {
    try { return JSON.parse(localStorage.getItem(key)) || null; }
    catch(e) { return null; }
  }
  function formatCurrency(num) {
    return '₦' + Number(num).toLocaleString();
  }
  function showSection(id) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    const sec = document.getElementById(id);
    if (sec) sec.classList.add('active');
  }

  // --- INIT DATA FROM STORAGE ---
  function initData() {
    const p = loadData(STORAGE_KEYS.PRODUCTS);
    if (p) state.products = p;
    const c = loadData(STORAGE_KEYS.CART);
    if (c) state.cart = c;
    const a = loadData(STORAGE_KEYS.ADMIN);
    if (a) state.adminCredentials = a;
    const cust = loadData(STORAGE_KEYS.CUSTOMIZATION);
    if (cust) state.customization = cust;
    const ord = loadData(STORAGE_KEYS.ORDERS);
    if (ord) state.orders = ord;
  }

  // --- RENDER PRODUCTS WITH PAGINATION ---
  const ITEMS_PER_PAGE = 6;
  let currentPage = 1;

  function renderProducts(page = 1) {
    currentPage = page;
    const list = document.getElementById('product-list');
    list.innerHTML = '';
    const start = (page - 1) * ITEMS_PER_PAGE;
    const pageProducts = state.products.slice(start, start + ITEMS_PER_PAGE);

    pageProducts.forEach(prod => {
      const div = document.createElement('div');
      div.className = 'product-card';
      div.innerHTML = `
        <img src="${prod.image}" alt="${prod.name}" class="product-image" />
        <div class="product-name">${prod.name}</div>
        <div class="product-price">${formatCurrency(prod.price)}</div>
        <div class="product-stock">Stock: ${prod.stock ?? 'Unlimited'}</div>
        <div>
          <label>Color:
            <select class="color-select">
              ${prod.colors ? prod.colors.map(c => `<option>${c.trim()}</option>`).join('') : '<option>Default</option>'}
            </select>
          </label>
          <label>Size:
            <select class="size-select">
              ${prod.sizes ? prod.sizes.map(s => `<option>${s.trim()}</option>`).join('') : '<option>Default</option>'}
            </select>
          </label>
        </div>
        <div>
          <label>Qty:
            <input type="number" min="1" value="1" class="qty-input" style="width: 60px;" />
          </label>
        </div>
        <button class="btn add-to-cart-btn">Add to Cart</button>
      `;
      list.appendChild(div);

      // Add to Cart handler
      div.querySelector('.add-to-cart-btn').onclick = () => {
        const qty = parseInt(div.querySelector('.qty-input').value) || 1;
        const color = div.querySelector('.color-select').value;
        const size = div.querySelector('.size-select').value;
        addToCart(prod.id, qty, color, size);
      };
    });

    renderPagination();
  }

  function renderPagination() {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    const pageCount = Math.ceil(state.products.length / ITEMS_PER_PAGE);
    if (pageCount <= 1) return;

    for (let i = 1; i <= pageCount; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.disabled = (i === currentPage);
      btn.onclick = () => renderProducts(i);
      pagination.appendChild(btn);
    }
  }

  // --- CART FUNCTIONS ---
  function addToCart(id, qty, color, size) {
    const prod = state.products.find(p => p.id === id);
    if (!prod) return alert('Product not found');
    const allowStockpiling = state.customization.allowStockpiling;
    const existing = state.cart.find(i => i.id === id && i.color === color && i.size === size);
    const maxStock = prod.stock ?? 9999;
    let totalQty = qty;
    if (existing) totalQty += existing.qty;
    if (!allowStockpiling && totalQty > maxStock) {
      return alert(`Cannot add ${qty}. Only ${maxStock - (existing ? existing.qty : 0)} left in stock.`);
    }

    if (existing) {
      existing.qty += qty;
    } else {
      state.cart.push({ id, qty, color, size });
    }
    saveData(STORAGE_KEYS.CART, state.cart);
    renderCart();
    alert('Added to cart');
  }

  function renderCart() {
    const container = document.getElementById('cart-items');
    container.innerHTML = '';
    if(state.cart.length === 0) {
      container.textContent = 'Your cart is empty.';
      return;
    }

    state.cart.forEach((item, index) => {
      const prod = state.products.find(p => p.id === item.id);
      if(!prod) return;
      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <div>${prod.name} ${item.color ? '(' + item.color + ')' : ''} ${item.size ? '[' + item.size + ']' : ''}</div>
        <div>
          Qty: <input type="number" class="cart-qty-input" min="1" value="${item.qty}" />
          <button class="btn remove-btn">Remove</button>
        </div>
        <div>${formatCurrency(prod.price * item.qty)}</div>
      `;
      container.appendChild(div);

      // Qty change handler
      div.querySelector('.cart-qty-input').addEventListener('change', e => {
        const newQty = parseInt(e.target.value);
        if (isNaN(newQty) || newQty < 1) {
          e.target.value = item.qty;
          return;
        }
        const allowStockpiling = state.customization.allowStockpiling;
        const maxStock = prod.stock ?? 9999;
        if (!allowStockpiling && newQty > maxStock) {
          alert(`Only ${maxStock} units in stock.`);
          e.target.value = item.qty;
          return;
        }
        item.qty = newQty;
        saveData(STORAGE_KEYS.CART, state.cart);
        renderCart();
      });

      // Remove handler
      div.querySelector('.remove-btn').onclick = () => {
        state.cart.splice(index, 1);
        saveData(STORAGE_KEYS.CART, state.cart);
        renderCart();
      };
    });
  }

  // --- CHECKOUT ---
  function getDeliveryFee(area) {
    if (!state.customization.deliveryFees) return 0;
    if(area === 'Others') return 0;
    if(area === 'Outside Lagos') return state.customization.deliveryFees['Outside Lagos'] || 0;
    return state.customization.deliveryFees[area] || 0;
  }

  function updateCheckoutSummary() {
    const subtotal = state.cart.reduce((sum, item) => {
      const prod = state.products.find(p => p.id === item.id);
      return prod ? sum + prod.price * item.qty : sum;
    }, 0);
    const deliveryArea = document.getElementById('delivery-area').value;
    const shippingFee = getDeliveryFee(deliveryArea);
    document.getElementById('checkout-subtotal').textContent = formatCurrency(subtotal);
    document.getElementById('checkout-shipping-fee').textContent = deliveryArea === 'Others' ? 'Pending' : formatCurrency(shippingFee);
    const total = deliveryArea === 'Others' ? subtotal : subtotal + shippingFee;
    document.getElementById('checkout-total').textContent = formatCurrency(total);

    const allowStockpiling = state.customization.allowStockpiling;
    const stockMsgDiv = document.getElementById('stockpiling-msg');
    if(!allowStockpiling) {
      const overStockItems = state.cart.filter(i => {
        const prod = state.products.find(p => p.id === i.id);
        return prod && i.qty > (prod.stock ?? 0);
      });
      if(overStockItems.length > 0) {
        stockMsgDiv.style.display = 'block';
        stockMsgDiv.textContent = 'Some items in your cart exceed current stock. Please adjust quantities.';
      } else {
        stockMsgDiv.style.display = 'none';
        stockMsgDiv.textContent = '';
      }
    } else {
      stockMsgDiv.style.display = 'none';
      stockMsgDiv.textContent = '';
    }
  }

  function populateDeliveryAreas() {
    const select = document.getElementById('delivery-area');
    if(!select) return;
    select.innerHTML = '';
    if(!state.customization.deliveryFees) return;

    const areas = Object.keys(state.customization.deliveryFees)
      .filter(a => a !== 'Others')
      .sort();
    areas.push('Others');

    areas.forEach(area => {
      const fee = state.customization.deliveryFees[area];
      const option = document.createElement('option');
      option.value = area;
      option.textContent = area + (area === 'Others' ? ' (Contact us for fee)' : ` (₦${fee.toLocaleString()})`);
      select.appendChild(option);
    });
  }

  function handleDeliveryAreaChange() {
    const select = document.getElementById('delivery-area');
    const msgDiv = document.getElementById('delivery-area-msg');
    const selected = select.value;
    if(selected === 'Others') {
      msgDiv.style.display = 'block';
      msgDiv.innerHTML = `
        Delivery fee for your area is not listed.<br/>
        Please proceed with checkout, then <a href="https://wa.me/${state.customization.whatsapp}" target="_blank" style="color: #25D366; font-weight: bold;">contact us on WhatsApp</a> to arrange delivery fee and details.
      `;
    } else {
      msgDiv.style.display = 'none';
      msgDiv.textContent = '';
    }
    updateCheckoutSummary();
  }

  // --- ORDER HANDLING ---
  // Save orders to localStorage (simulate backend)
  function saveOrder(order) {
    state.orders.push(order);
    saveData(STORAGE_KEYS.ORDERS, state.orders);
  }

  // --- EMAILJS ---
  // Uses your EmailJS public key, service ID, and templates from earlier
  async function sendOrderEmails(order) {
    const serviceID = 'service_opcf6cl'; // your service ID
    const templateCustomer = 'template_4zrsdni'; // customer email template
    const templateAdmin = 'template_zc87bdl'; // admin email template

    try {
      // Customer email
      await emailjs.send(serviceID, templateCustomer, {
        to_name: order.name,
        to_email: order.email,
        order_id: order.id,
        order_details: JSON.stringify(order.items, null, 2),
        total_amount: formatCurrency(order.total)
      });

      // Admin email
      await emailjs.send(serviceID, templateAdmin, {
        order_id: order.id,
        customer_name: order.name,
        customer_email: order.email,
        customer_phone: order.phone,
        delivery_address: order.address,
        delivery_area: order.deliveryArea,
        order_details: JSON.stringify(order.items, null, 2),
        total_amount: formatCurrency(order.total)
      });
      alert('Order placed successfully! Confirmation emails sent.');
    } catch (e) {
      alert('Order placed but failed to send emails. Please check your EmailJS setup.');
      console.error(e);
    }
  }

  // --- USER AUTH ---
  function checkLogin() {
    if(state.currentUser && state.currentUser.email === state.adminCredentials?.email) {
      showSection('admin-panel');
      document.getElementById('logout-btn').style.display = 'inline-block';
      populateAdmin();
    } else {
      showSection('shopping-area');
      document.getElementById('logout-btn').style.display = 'inline-block';
      renderProducts();
      renderCart();
      applyCustomization();
    }
  }

  // --- LOGIN FORM ---
  document.getElementById('login-form').addEventListener('submit', e => {
    e.preventDefault();
    const email = e.target['login-email'].value.trim();
    const password = e.target['login-password'].value;
    if(!state.adminCredentials) {
      // First time setup: save these credentials as admin
      state.adminCredentials = { email, password };
      saveData(STORAGE_KEYS.ADMIN, state.adminCredentials);
      alert('Admin account created! You can now login with these credentials.');
      state.currentUser = { email };
      checkLogin();
      return;
    }
    if(state.adminCredentials.email === email && state.adminCredentials.password === password) {
      state.currentUser = { email };
      checkLogin();
    } else {
      alert('Invalid admin credentials');
    }
  });

  // --- LOGOUT ---
  document.getElementById('logout-btn').addEventListener('click', () => {
    state.currentUser = null;
    showSection('login-screen');
    document.getElementById('logout-btn').style.display = 'none';
  });

  // --- ADMIN PANEL ---

  // Load customization data to form
  function populateAdmin() {
    document.getElementById('store-name-input').value = state.customization.storeName || '';
    document.getElementById('whatsapp-input').value = state.customization.whatsapp || '';
    document.getElementById('stockpiling-select').value = state.customization.allowStockpiling ? 'true' : 'false';
    document.getElementById('delivery-fees-input').value = JSON.stringify(state.customization.deliveryFees, null, 2);
    renderAdminProducts();
  }

  // Save customization
  document.getElementById('customization-form').addEventListener('submit', e => {
    e.preventDefault();
    const storeName = document.getElementById('store-name-input').value.trim();
    const whatsapp = document.getElementById('whatsapp-input').value.trim();
    const allowStockpiling = document.getElementById('stockpiling-select').value === 'true';
    let deliveryFees = {};
    try {
      deliveryFees = JSON.parse(document.getElementById('delivery-fees-input').value);
    } catch {
      alert('Invalid JSON for delivery fees');
      return;
    }
    state.customization = { storeName, whatsapp, allowStockpiling, deliveryFees };
    saveData(STORAGE_KEYS.CUSTOMIZATION, state.customization);
    alert('Customization saved');
    applyCustomization();
  });

  // PRODUCT FORM HANDLING
  document.getElementById('product-form').addEventListener('submit', e => {
    e.preventDefault();
    const id = document.getElementById('product-id').value || Date.now().toString();
    const name = document.getElementById('product-name').value.trim();
    const price = Number(document.getElementById('product-price').value);
    const desc = document.getElementById('product-desc').value.trim();
    const stock = Number(document.getElementById('product-stock').value) || null;
    const colors = document.getElementById('product-colors').value.split(',').map(c => c.trim()).filter(c => c);
    const sizes = document.getElementById('product-sizes').value.split(',').map(s => s.trim()).filter(s => s);
    const image = document.getElementById('product-image').value.trim();

    if (!name || !price || !image) {
      alert('Name, Price, and Image are required');
      return;
    }

    const existingIndex = state.products.findIndex(p => p.id === id);
    const prodData = { id, name, price, description: desc, stock, colors, sizes, image };
    if(existingIndex >= 0) {
      state.products[existingIndex] = prodData;
    } else {
      state.products.push(prodData);
    }
    saveData(STORAGE_KEYS.PRODUCTS, state.products);
    alert('Product saved');
    e.target.reset();
    document.getElementById('product-id').value = '';
    renderAdminProducts();
  });

  // Render admin products list with edit and delete
  function renderAdminProducts() {
    const list = document.getElementById('admin-products-list');
    list.innerHTML = '';
    if(state.products.length === 0) {
      list.textContent = 'No products added yet.';
      return;
    }
    state.products.forEach(prod => {
      const div = document.createElement('div');
      div.className = 'admin-product';
      div.innerHTML = `
        <img src="${prod.image}" alt="${prod.name}" />
        <div>
          <strong>${prod.name}</strong><br/>
          ₦${prod.price.toLocaleString()}<br/>
          Stock: ${prod.stock ?? 'Unlimited'}
        </div>
        <div>
          <button class="admin-btn edit-btn">Edit</button>
          <button class="admin-btn delete-btn">Delete</button>
        </div>
      `;
      list.appendChild(div);

      div.querySelector('.edit-btn').onclick = () => {
        document.getElementById('product-id').value = prod.id;
        document.getElementById('product-name').value = prod.name;
        document.getElementById('product-price').value = prod.price;
        document.getElementById('product-desc').value = prod.description;
        document.getElementById('product-stock').value = prod.stock ?? '';
        document.getElementById('product-colors').value = prod.colors ? prod.colors.join(', ') : '';
        document.getElementById('product-sizes').value = prod.sizes ? prod.sizes.join(', ') : '';
        document.getElementById('product-image').value = prod.image;
      };

      div.querySelector('.delete-btn').onclick = () => {
        if(confirm(`Delete product "${prod.name}"?`)) {
          state.products = state.products.filter(p => p.id !== prod.id);
          saveData(STORAGE_KEYS.PRODUCTS, state.products);
          renderAdminProducts();
        }
      };
    });
  }

  // --- NAVIGATION BUTTONS ---
  document.getElementById('back-to-shop-btn').addEventListener('click', () => {
    state.currentUser = null;
    showSection('shopping-area');
    document.getElementById('logout-btn').style.display = 'none';
    renderProducts();
    renderCart();
    applyCustomization();
  });

  // --- CHECKOUT PROCESS ---
  document.getElementById('proceed-to-checkout').addEventListener('click', () => {
    if(state.cart.length === 0) {
      alert('Your cart is empty');
      return;
    }
    populateDeliveryAreas();
    handleDeliveryAreaChange();
    updateCheckoutSummary();
    document.getElementById('checkout').classList.remove('hidden');
    window.scrollTo(0,document.body.scrollHeight);
  });

  document.getElementById('delivery-area').addEventListener('change', handleDeliveryAreaChange);

  document.getElementById('checkout-form').addEventListener('submit', async e => {
    e.preventDefault();
    const name = e.target['checkout-name'].value.trim();
    const email = e.target['checkout-email'].value.trim();
    const phone = e.target['checkout-phone'].value.trim();
    const address = e.target['checkout-address'].value.trim();
    const deliveryArea = e.target['delivery-area'].value;

    if(!name || !email || !phone || !address || !deliveryArea) {
      alert('Please fill in all fields');
      return;
    }

    // Calculate totals again
    const subtotal = state.cart.reduce((sum, item) => {
      const prod = state.products.find(p => p.id === item.id);
      return prod ? sum + prod.price * item.qty : sum;
    }, 0);
    const shippingFee = getDeliveryFee(deliveryArea);
    const total = deliveryArea === 'Others' ? subtotal : subtotal + shippingFee;

    // Save order
    const order = {
      id: Date.now().toString(),
      name, email, phone, address, deliveryArea,
      items: JSON.parse(JSON.stringify(state.cart)), // deep copy
      total,
      status: 'PENDING',
      date: new Date().toISOString()
    };
    saveOrder(order);

    // Clear cart
    state.cart = [];
    saveData(STORAGE_KEYS.CART, state.cart);
    renderCart();
    document.getElementById('checkout').classList.add('hidden');

    // Send emails with EmailJS
    await sendOrderEmails(order);
  });

  // --- DARK MODE ---
  const darkModeToggle = document.getElementById('dark-mode-toggle');
  function loadDarkMode() {
    const saved = localStorage.getItem('dark_mode');
    if(saved === 'true') document.body.classList.add('dark');
  }
  function toggleDarkMode() {
    document.body.classList.toggle('dark');
    localStorage.setItem('dark_mode', document.body.classList.contains('dark'));
  }
  darkModeToggle.onclick = toggleDarkMode;

  // --- CUSTOMIZATION APPLY ---
  function applyCustomization() {
    document.querySelectorAll('.store-name').forEach(el => el.textContent = state.customization.storeName || 'My Store');
    const whatsappLink = document.getElementById('whatsapp-link');
    whatsappLink.href = `https://wa.me/${state.customization.whatsapp || '2348012345678'}`;
  }

  // --- ON LOAD ---
  (function() {
    initData();
    loadDarkMode();

    if(state.currentUser && state.currentUser.email === state.adminCredentials?.email) {
      checkLogin();
    } else {
      showSection('login-screen');
    }
  })();
</script>

</body>
</html>
